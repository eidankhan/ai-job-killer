<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - AI Job Risk</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="auth.css">
</head>

<body class="auth-body">

    <div class="auth-container">

        <div id="request-card" class="auth-card shadow-sm">
            <div class="card-body p-4 p-md-5">

                <h1 class="auth-title h3 mb-3 text-center">
                    Forgot Your Password?
                </h1>
                <p class="auth-subtitle text-center text-muted mb-4">
                    No problem. Enter your email and we'll send you a verification code.
                </p>

                <form id="request-form" onsubmit="handleRequestCode(event); return false;">

                    <div class="form-floating mb-4">
                        <input type="email" class="form-control" id="forgot-email" placeholder="name@example.com"
                            required>
                        <label for="forgot-email">Email address</label>
                    </div>

                    <div id="request-alert" class="alert" style="display: none;"></div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg auth-btn" id="request-button">
                            <span class="btn-text">Send Code</span>
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                                style="display: none;"></span>
                        </button>
                    </div>
                </form>

                <div class="text-center mt-4 pt-3 border-top">
                    <p class="text-muted mb-0">
                        Remembered your password?
                        <a href="login.html" class="auth-link fw-bold">Back to Login</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="reset-card" class="auth-card shadow-sm" style="display: none;">
            <div class="card-body p-4 p-md-5">

                <h1 class="auth-title h3 mb-3 text-center">
                    Set a New Password
                </h1>
                <p class="auth-subtitle text-center text-muted mb-4">
                    We sent a code to <strong id="user-email-placeholder">your-email@example.com</strong>.
                </p>

                <form id="reset-form" onsubmit="handleResetPassword(event); return false;">

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="reset-code" placeholder="123456" required>
                        <label for="reset-code">Verification Code</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="reset-password" placeholder="New Password"
                            required minlength="8">
                        <label for="reset-password">New Password</label>
                    </div>

                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="reset-password-confirm"
                            placeholder="Confirm New Password" required minlength="8">
                        <label for="reset-password-confirm">Confirm New Password</label>
                    </div>

                    <div id="reset-alert" class="alert" style="display: none;"></div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg auth-btn" id="reset-button">
                            <span class="btn-text">Reset Password</span>
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                                style="display: none;"></span>
                        </button>
                    </div>
                </form>

                <div class="text-center mt-4 pt-3 border-top">
                    <p class="text-muted mb-0">
                        <a href="login.html" class="auth-link fw-bold">Back to Login</a>
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        // --- 1. HARDCODED CONFIG ---
        const API_BASE_URL = window.APP_CONFIG.API_BASE_URL;

        // --- 2. HARDCODED AUTH-UI HELPER ---
        // This is defined globally so the 'onsubmit' functions can use it.
        function setupAuthUI(buttonSelector, alertSelector) {
            const $button = $(buttonSelector);
            const $alert = $(alertSelector);
            const $btnText = $button.find('.btn-text');
            const $spinner = $button.find('.spinner-border');

            return {
                showLoading: () => {
                    $btnText.hide();
                    $spinner.show();
                    $button.prop('disabled', true);
                    $alert.hide().removeClass('alert-danger alert-success');
                },
                hideLoading: () => {
                    $btnText.show();
                    $spinner.hide();
                    $button.prop('disabled', false);
                },
                showError: (message) => {
                    $alert.text(message).addClass('alert-danger').show();
                },
                showSuccess: (message) => {
                    $alert.text(message).addClass('alert-success').show();
                }
            };
        }

        // --- 3. PAGE LOGIC ---

        // --- STATE ---
        let userEmail = '';

        // --- SETUP ---
        // We create two separate UI helpers, one for each form
        const requestUI = setupAuthUI('#request-button', '#request-alert');
        const resetUI = setupAuthUI('#reset-button', '#reset-alert');


        /**
         * Handles STEP 1: Requesting the password reset code
         * This function is now global and called by 'onsubmit'.
         */
        function handleRequestCode(event) {
            event.preventDefault(); // Stop the reload
            event.stopPropagation();

            const email = $('#forgot-email').val();

            if (!email) {
                requestUI.showError('Please enter your email address.');
                return false;
            }

            // 1. Show loading state
            requestUI.showLoading();

            // 2. Store the email for the next step
            userEmail = email;

            // 3. Make API call
            $.ajax({
                url: `${API_BASE_URL}/auth/send-forgot-password-code`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email: email }),

                success: function (data) {
                    // 4a. On Success: Hide request card, show reset card
                    requestUI.hideLoading();
                    $('#user-email-placeholder').text(userEmail); // Update email placeholder
                    $('#request-card').hide();
                    $('#reset-card').fadeIn();
                },

                error: function (xhr) {
                    // 4b. On Error: Hide loading and show error
                    requestUI.hideLoading();
                    let errorMsg = 'Could not send reset code. Please check your email.';
                    if (xhr.responseJSON && xhr.responseJSON.detail) {
                        if (typeof xhr.responseJSON.detail === 'string') {
                            errorMsg = xhr.responseJSON.detail;
                        }
                    }
                    requestUI.showError(errorMsg);
                }
            });

            return false; // Final backup to stop submission
        }

        /**
         * Handles STEP 2: Submitting the code and new password
         * This function is now global and called by 'onsubmit'.
         */
        function handleResetPassword(event) {
            event.preventDefault(); // Stop the reload
            event.stopPropagation();

            const code = $('#reset-code').val();
            const newPassword = $('#reset-password').val();
            const confirmPassword = $('#reset-password-confirm').val();

            if (!userEmail) {
                // This can happen if the user refreshes the page in step 2
                // We'll try to get it from localStorage
                userEmail = localStorage.getItem('passwordResetEmail');
                if (!userEmail) {
                    resetUI.showError("Session expired. Please start over.");
                    return false;
                }
            }

            // Client-side validation
            if (newPassword !== confirmPassword) {
                resetUI.showError('Passwords do not match.');
                return false;
            }

            // 1. Show loading state
            resetUI.showLoading();

            // 2. Make API call
            $.ajax({
                url: `${API_BASE_URL}/auth/reset-password`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    email: userEmail,
                    code: code,
                    new_password: newPassword
                }),

                success: function (data) {
                    // 3a. On Success: Show success and redirect to login
                    localStorage.removeItem('passwordResetEmail'); // Clean up
                    resetUI.hideLoading();
                    resetUI.showSuccess('Password reset! Redirecting to login...');

                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000); // 2-second delay
                },

                error: function (xhr) {
                    // 3b. On Error: Hide loading and show error
                    resetUI.hideLoading();
                    let errorMsg = 'Invalid code or expired request.';
                    if (xhr.responseJSON && xhr.responseJSON.detail) {
                        if (typeof xhr.responseJSON.detail === 'string') {
                            errorMsg = xhr.responseJSON.detail;
                        }
                    }
                    resetUI.showError(errorMsg);
                }
            });

            return false; // Final backup to stop submission
        }

        // We also need to pre-fill the email if the user reloads on step 2
        $(document).ready(function () {
            // This logic runs on page load
            const storedEmail = localStorage.getItem('passwordResetEmail');
            if (storedEmail) {
                // If we have a stored email, assume we are on step 2
                userEmail = storedEmail;
                $('#user-email-placeholder').text(userEmail);
                $('#request-card').hide();
                $('#reset-card').show();
            }
        });

    </script>
</body>

</html>